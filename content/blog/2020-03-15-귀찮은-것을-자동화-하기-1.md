---
title: 귀찮은 것을 자동화 하기(1)
date: 2020-03-15T05:55:40.418Z
description: 브랜치를 변경할 때 package-lock.json을 자동으로 체크하게 해보자
---
프로젝트를 다루다보면 노드 패키지를 추가하는 경우가 있고, 노드 패키지가 추가 되었다는 것을 전달받지 못했거나, 이런 저런 브랜치를 돌아다녀야 할 경우 깜빡하고 추가된 패키지를 설치하지 않으면 개발 서버를 돌리거나 빌드시 에러가 발생해 귀찮을 경우가 종종 있다. 추가되는 일이 생길 때 마다 동료 개발자에게 알려주거나 PR에 레이블을 달거나 할수도 있지만, 귀찮은 일이고, 자동으로 되는 쪽이 역시 좋을 것이다.

## git hooks
git에선 각 git 조작 단계에 맞춰 hook을 제공한다. `.git/hooks` 폴더 안에 hook 이름의 파일을 추가해 shell script를 작성해두면 해당 단계에 그대로 동작한다.

패키지 설치가 필요한 단계는 아마도 `checkout` 후 혹은 `merge` 후 일 것이다. 해당 git hook은 `post-checkout`과 `post-merge`다. 이 포스트에선 일단 `checkout` 케이스부터 처리해본다[^1].

## git hooks 추가하기
관련 `git hook` 과 같은 이름의 파일을 `.git/` 에 추가해주면 된다. 프로젝트 폴더의 `root` 위치에 있다고 가정하고, 파일을 추가하자.

```sh
touch .git/post-checkout
```

## 어떤 파일들이 바뀌었는지 보기

checkout 후 이전 브랜치와 비교해 바뀐 파일들의 목록은 아래 git 커맨드로 볼 수 있다.

```sh
git diff-tree -r --name-only --no-commit-id @{-1} HEAD
```

위 커맨드에서 `@{-1}`은 이전 브랜치의 `HEAD`, `HEAD`는 현재 브랜치의 `HEAD`를 가리킨다.

## 바뀐 파일들 중 특정 문자열이 있나 보고 특정 커맨드를 실행하기

위 커맨드를 사용해 목록화한 파일명들 중 `packpage-lock.json`이 있는지 보고, `npm ci`를 실행하는 스크립트를 짜보면 아래와 같이 될 것이다.

```sh
!#/bin/sh

changed_files="$(git diff-tree -r --name-only --no-commit-id @{-1} HEAD)"

echo $changed_files | grep "package-lock.json" && eval "npm ci"
```

끝이다. 위 `git hook` 스크립트가 있는 리포지토리는 이제 브랜치가 바뀔 때 마다 `package-lock.json` 을 체크하고 변경사항이 있으면 `npm ci` 를 실행하게 된다. (끝)

[^1]: `post-merge`시엔 바뀐 파일을 보는 커맨드 중 `@{-1}`을 `ORIG_HEAD`로 바꿔주기만 하면 된다. `git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD`
